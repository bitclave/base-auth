!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("BASEAuth",[],n):"object"==typeof exports?exports.BASEAuth=n():t.BASEAuth=n()}(window,function(){return function(t){var n={};function i(e){if(n[e])return n[e].exports;var r=n[e]={i:e,l:!1,exports:{}};return t[e].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=n,i.d=function(t,n,e){i.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:e})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(n,"a",n),n},i.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},i.p="",i(i.s=0)}([function(t,n,i){"use strict";function e(t,n,i,e){this.id=t,this.methodName=n,this.args=i,this.resolve=e}function r(t,n){this._targetWindow=t,this._targetOrigin=n,this._calls={},this._listeners={},this._currentCallId=1,"*"!==this._targetOrigin&&"/"!==this._targetOrigin[this._targetOrigin.length-1]&&(this._targetOrigin+="/"),window.addEventListener("message",this._onMessage.bind(this))}i.r(n),e.prototype.send=function(t,n){t.postMessage({rpcCall:{id:this.id,methodName:this.methodName,args:this.args}},n)},e.prototype.respond=function(t,n,i){t.postMessage({rpcCall:{id:this.id,methodName:this.methodName,args:this.args,value:i}},n)},r.prototype.call=function(t,n){return new Promise(function(i,r){const s=this._currentCallId++;this._calls[s]=new e(s,t,n,i),this._calls[s].send(this._targetWindow,this._targetOrigin)}.bind(this))},r.prototype.listen=function(t,n){this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(n)},r.prototype.once=function(t){return new Promise(function(n,i){this._listeners[t]||(this._listeners[t]=[]);const e=this._listeners[t];e.push(function(t){e.splice(e.indexOf(this),1),n(t)})}.bind(this))},r.prototype._onMessage=function(t){let n=t.origin;if("/"!==n[n.length-1]&&(n=t.origin+"/"),"*"!==this._targetOrigin&&n!==this._targetOrigin)return;if(t.source!==this._targetWindow)return;if(!t.data.rpcCall)return;const i=new e(t.data.rpcCall.id,t.data.rpcCall.methodName,t.data.rpcCall.args),r=this._listeners[t.data.rpcCall.methodName];if(r)for(let t=0,n=r.length;t<n;t++)r[t](i);this._calls[t.data.rpcCall.id]&&(this._calls[t.data.rpcCall.id].resolve(t.data.rpcCall.value),delete this._calls[t.data.rpcCall.id])};i(3);class s{constructor(t,n,i,e){this.widgetOrigin=t,this.widgetRpc=new r(window.opener,t),this.$inputMnemonic=n,this.$buttonSignup=i,this.$buttonSignin=e,this.$buttonSignup.on("click",this._onClickSignin.bind(this)),this.$buttonSignin.on("click",this._onClickSignin.bind(this))}_onClickSignin(){const t=this._parseMnemonic();t&&this.widgetRpc.call("submitMnenomic",[t])}_parseMnemonic(){return this.$inputMnemonic.val()}}function o(t,n,i,e,r){this._popupUrl=i,this._popupName=e,this._widgetOrigin=r,this._baseNodeApi=new Base.NodeAPI(t),this._parent=window.parent,this._parentOrigin=null,this._parentRpc=null,n.on("click",this._onClickLogin.bind(this))}o.prototype._onClickLogin=function(t){const n=$(t.target),i=window.open(this._popupUrl,this._popupName,"height=500, width=500");new r(i,this._widgetOrigin).once("submitMnenomic").then(function(t){return n.prop("disabled",!0),n.text("Loading..."),this._login(t.args[0])}.bind(this)).then(function(){n.text("Logged in!")}),i.focus()},o.prototype._login=function(t){return new r(this._parent,"*").call("getOrigin",[]).then(function(t){this._parentOrigin=t,this._parentRpc=new r(this._parent,this._parentOrigin)}.bind(this)).then(function(){return this._baseNodeApi.accountManager.checkAccount(t)}.bind(this)).then(function(t){return t},function(n){if(404==n.status)return this._baseNodeApi.accountManager.registration(t)}.bind(this)).then(function(t){this._parentRpc.call("onLogin",[t]),this._listen()}.bind(this))},o.prototype._listen=function(){this._parentRpc.listen("offerManager.getAllOffers",this._getAllOffers.bind(this)),this._parentRpc.listen("profileManager.getData",this._getData.bind(this)),this._parentRpc.listen("profileManager.updateData",this._updateData.bind(this))},o.prototype._respond=function(t,n){t.respond(this._parent,this._parentOrigin,n)},o.prototype._getAllOffers=function(t){this._baseNodeApi.offerManager.getAllOffers().then(this._respond.bind(this,t))},o.prototype._getData=function(t){this._baseNodeApi.profileManager.getData().then(this._respond.bind(this,t))},o.prototype._updateData=function(t){const n=t.args[0],i=new Map(Object.keys(n).map(t=>[t,n[t]]));this._baseNodeApi.profileManager.updateData(i).then(this._respond.bind(this,t))},i.d(n,"IFrameRPC",function(){return r}),i.d(n,"PopupView",function(){return s}),i.d(n,"WidgetView",function(){return o})},function(t,n){for(var i=[],e=0;e<256;++e)i[e]=(e+256).toString(16).substr(1);t.exports=function(t,n){var e=n||0,r=i;return r[t[e++]]+r[t[e++]]+r[t[e++]]+r[t[e++]]+"-"+r[t[e++]]+r[t[e++]]+"-"+r[t[e++]]+r[t[e++]]+"-"+r[t[e++]]+r[t[e++]]+"-"+r[t[e++]]+r[t[e++]]+r[t[e++]]+r[t[e++]]+r[t[e++]]+r[t[e++]]}},function(t,n){var i="undefined"!=typeof crypto&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&msCrypto.getRandomValues.bind(msCrypto);if(i){var e=new Uint8Array(16);t.exports=function(){return i(e),e}}else{var r=new Array(16);t.exports=function(){for(var t,n=0;n<16;n++)0==(3&n)&&(t=4294967296*Math.random()),r[n]=t>>>((3&n)<<3)&255;return r}}},function(t,n,i){var e=i(2),r=i(1);t.exports=function(t,n,i){var s=n&&i||0;"string"==typeof t&&(n="binary"===t?new Array(16):null,t=null);var o=(t=t||{}).random||(t.rng||e)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,n)for(var a=0;a<16;++a)n[s+a]=o[a];return n||r(o)}}])});